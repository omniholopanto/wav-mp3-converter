<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversor de Áudio Protegido</title>
    <style>
        body {
            background-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #333;
            line-height: 1.5;
            margin: 0;
            padding: 0;
        }
        #tool-container {
            width: 100%;
            max-width: 600px;
            padding: 1.5rem 1rem;
            box-sizing: border-box;
            text-align: center;
        }
        #security-block {
            display: none;
            padding: 2rem;
            text-align: center;
            font-weight: bold;
            color: #d93025;
        }
        h1 {
            color: #1a73e8;
            font-size: 1.8em;
            margin-top: 0;
            margin-bottom: 0.5rem;
        }
        p { margin-bottom: 1.5rem; }
        #audioFileInput, #outputFormatSelect, #convertButton { display: block; width: 100%; margin-top: 1rem; padding: 0.8rem; border-radius: 4px; border: 1px solid #ddd; font-size: 1rem; box-sizing: border-box; }
        #convertButton { background-color: #1a73e8; color: white; border: none; cursor: pointer; transition: background-color 0.3s; }
        #convertButton:hover { background-color: #1558b8; }
        #output { margin-top: 1.5rem; font-weight: bold; word-wrap: break-word; }
        #output a { display: inline-block; background-color: #28a745; color: white; padding: 0.8rem 1.5rem; border-radius: 4px; text-decoration: none; margin-top: 0.5rem; transition: background-color 0.3s; }
        #output a:hover { background-color: #218838; }
    </style>
</head>
<body>

    <div id="tool-container">
        <h1>Conversor de Áudio</h1>
        <p>Selecione um arquivo (WAV ou MP3) e o formato de destino.</p>
        <input type="file" id="audioFileInput" accept=".mp3,.wav">
        <select id="outputFormatSelect">
            <option value="mp3">Para MP3</option>
            <option value="wav">Para WAV</option>
        </select>
        <button id="convertButton">Converter</button>
        <div id="output"></div>
    </div>

    <div id="security-block">
        <p>Esta ferramenta está disponível exclusivamente em omniholopanto.blogspot.com.</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script>
    <script>
        // --- INÍCIO DO SCRIPT DE SEGURANÇA (VERSÃO CORRIGIDA) ---

        const allowedDomain = 'omniholopanto.blogspot.com';

        function runSecurityCheck() {
            const toolContainer = document.getElementById('tool-container');
            const securityBlock = document.getElementById('security-block');
            let isAllowed = false;

            try {
                if (window.top !== window.self) {
                    const parentHostname = window.top.location.hostname;
                    
                    // LÓGICA CORRIGIDA:
                    // Verifica se o endereço do blog é uma correspondência exata OU
                    // se ele termina com ".omniholopanto.blogspot.com" para cobrir as variações de país.
                    if (parentHostname === allowedDomain || parentHostname.endsWith('.' + allowedDomain)) {
                        isAllowed = true;
                    }
                }
            } catch (e) {
                console.warn('Acesso de segurança bloqueado por exceção de origem cruzada.');
                isAllowed = false;
            }
            
            if (!isAllowed) {
                toolContainer.style.display = 'none';
                securityBlock.style.display = 'block';
            }
        }

        runSecurityCheck();

        // --- FIM DO SCRIPT DE SEGURANÇA ---


        // Lógica de conversão (sem alterações)
        document.getElementById('convertButton').addEventListener('click', () => {
            const audioFileInput = document.getElementById('audioFileInput');
            const outputFormat = document.getElementById('outputFormatSelect').value;
            const outputDiv = document.getElementById('output');
            
            if (audioFileInput.files.length === 0) {
                outputDiv.innerHTML = 'Por favor, selecione um arquivo de áudio.';
                return;
            }
            outputDiv.innerHTML = 'Processando, por favor aguarde...';

            const file = audioFileInput.files[0];
            const reader = new FileReader();

            reader.onload = async (event) => {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const audioBuffer = await audioContext.decodeAudioData(event.target.result);

                    if (outputFormat === 'mp3') {
                        if (file.type === 'audio/mpeg') {
                            outputDiv.innerHTML = 'O arquivo já está no formato MP3.';
                            return;
                        }
                        toMp3(audioBuffer);

                    } else if (outputFormat === 'wav') {
                        if (file.type === 'audio/wav') {
                            outputDiv.innerHTML = 'O arquivo já está no formato WAV.';
                            return;
                        }
                        toWav(audioBuffer);
                    }
                } catch (e) {
                    outputDiv.innerHTML = `Erro ao processar o arquivo. Tente um arquivo diferente.`;
                    console.error(e);
                }
            };

            reader.readAsArrayBuffer(file);
        });

        function toMp3(audioBuffer) {
            const sampleRate = audioBuffer.sampleRate;
            const mp3encoder = new lamejs.Mp3Encoder(1, sampleRate, 128);
            let samples = audioBuffer.getChannelData(0);

            if (audioBuffer.numberOfChannels > 1) {
                const rightSamples = audioBuffer.getChannelData(1);
                const mixedSamples = new Float32Array(samples.length);
                for (let i = 0; i < samples.length; i++) {
                    mixedSamples[i] = (samples[i] + rightSamples[i]) / 2;
                }
                samples = mixedSamples;
            }

            const samplesInt16 = new Int16Array(samples.length);
            for (let i = 0; i < samples.length; i++) {
                samplesInt16[i] = samples[i] * 32767;
            }

            const mp3Data = [];
            const samplesPerFrame = 1152;
            for (let i = 0; i < samplesInt16.length; i += samplesPerFrame) {
                const frame = samplesInt16.subarray(i, i + samplesPerFrame);
                const mp3buf = mp3encoder.encodeBuffer(frame);
                if (mp3buf.length > 0) {
                    mp3Data.push(mp3buf);
                }
            }
            const flushed = mp3encoder.flush();
            if (flushed.length > 0) {
                mp3Data.push(flushed);
            }

            const blob = new Blob(mp3Data, {type: 'audio/mp3'});
            const url = URL.createObjectURL(blob);
            displayDownloadLink(url, 'audio_convertido.mp3');
        }
        
        function toWav(audioBuffer) {
            const samples = audioBuffer.getChannelData(0);
            const sampleRate = audioBuffer.sampleRate;
            const buffer = new ArrayBuffer(44 + samples.length * 2);
            const view = new DataView(buffer);
            const writeString = (v, o, s) => { for (let i = 0; i < s.length; i++) v.setUint8(o + i, s.charCodeAt(i)); };
            const floatTo16BitPCM = (out, off, inp) => { for (let i = 0; i < inp.length; i++, off += 2) { const s = Math.max(-1, Math.min(1, inp[i])); out.setInt16(off, s < 0 ? s * 0x8000 : s * 0x7FFF, true); }};
            writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + samples.length * 2, true); writeString(view, 8, 'WAVE'); writeString(view, 12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true); writeString(view, 36, 'data'); view.setUint32(40, samples.length * 2, true); floatTo16BitPCM(view, 44, samples);
            const blob = new Blob([view], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            displayDownloadLink(url, 'audio_convertido.wav');
        }

        function displayDownloadLink(url, filename) {
            const outputDiv = document.getElementById('output');
            outputDiv.innerHTML = 'Conversão concluída! ';
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.innerHTML = `Baixar ${filename}`;
            outputDiv.appendChild(link);
        }
    </script>
</body>
</html>```
